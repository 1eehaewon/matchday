<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.matchday.order.OrderDAO">

    <!-- 주어진 날짜에 대한 최대 주문 ID 가져오기 -->
    <select id="getMaxOrderId" resultType="String" parameterType="String">
        SELECT MAX(orderid)
        FROM `order`
        WHERE orderid LIKE CONCAT('order', #{date}, '%')
    </select>

    <!-- 주문 정보 삽입 -->
    <insert id="insert" parameterType="kr.co.matchday.order.OrderDTO">
        INSERT INTO `order` (orderid, userid, goodsid, orderdate, orderstatus, couponid, usedpoints, finalpaymentamount, shippingstartdate, shippingstatus, recipientname, recipientemail, recipientphone, shippingaddress, shippingrequest, paymentmethodcode, price, quantity, receiptmethodcode)
        VALUES (#{orderid}, #{userid}, #{goodsid}, #{orderdate}, #{orderstatus}, #{couponid}, #{usedpoints}, #{finalpaymentamount}, #{shippingstartdate}, #{shippingstatus}, #{recipientname}, #{recipientemail}, #{recipientphone}, #{shippingaddress}, #{shippingrequest}, #{paymentmethodcode}, #{price}, #{quantity}, #{receiptmethodcode})
    </insert>

    <!-- 사용자 ID로 주문 목록 가져오기 -->
    <select id="listByUser" parameterType="String" resultType="kr.co.matchday.order.OrderDTO">
        SELECT * FROM `order` WHERE userid = #{userid}
    </select>

    <!-- 사용자 정보 가져오기 -->
    <select id="getUserInfo" parameterType="String" resultType="Map">
        SELECT * FROM users WHERE userid = #{userid}
    </select>

    <!-- 사용자 ID로 쿠폰 목록 가져오기 -->
    <select id="getCouponsByUserId" resultType="kr.co.matchday.coupon.CouponDTO">
        SELECT c.couponid, c.coupontypeid, c.userid, c.usage,
               cm.couponname, cm.startdate, cm.enddate, cm.applicableproduct, cm.discountrate
        FROM coupon c
        JOIN couponmaster cm ON c.coupontypeid = cm.coupontypeid
        WHERE c.userid = #{userid}
          AND cm.applicableproduct = #{applicableProduct}
          AND c.usage = #{usage}
    </select>

    <!-- 쿠폰 ID로 할인율 가져오기 -->
    <select id="getDiscountRateByCouponId" resultType="int" parameterType="String">
        SELECT discountrate
        FROM couponmaster
        WHERE coupontypeid = (SELECT coupontypeid FROM coupon WHERE couponid = #{couponid})
    </select>

    <!-- 쿠폰 사용 여부 업데이트 -->
    <update id="updateCouponUsage" parameterType="String">
        UPDATE coupon
        SET `usage` = 'Used'
        WHERE couponid = #{couponid}
    </update>
</mapper>
