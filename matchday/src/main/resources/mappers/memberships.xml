<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="memberships">
    <insert id="insert" parameterType="kr.co.matchday.memberships.MembershipsDTO">
        INSERT INTO memberships (membershipid, membershipname, teamname, price, startdate, enddate, notes, discountamount, filename, filesize)
        VALUES (#{membershipid}, #{membershipname}, #{teamname}, #{price}, #{startdate}, #{enddate}, #{notes}, #{discountamount}, #{filename}, #{filesize})
    </insert>
    
    <select id="list" resultType="kr.co.matchday.memberships.MembershipsDTO">
        SELECT membershipid, membershipname, teamname, price, startdate, enddate, notes, discountamount, filename, filesize
        FROM memberships
        ORDER BY membershipid
    </select>

    <select id="detail" parameterType="string" resultType="kr.co.matchday.memberships.MembershipsDTO">
        SELECT membershipid, membershipname, teamname, price, startdate, enddate, notes, discountamount, filename, filesize
        FROM memberships
        WHERE membershipid = #{membershipid}
    </select>
    
    <update id="update" parameterType="kr.co.matchday.memberships.MembershipsDTO">
        UPDATE memberships
        SET membershipname = #{membershipname},
            teamname = #{teamname},
            price = #{price},
            startdate = #{startdate},
            enddate = #{enddate},
            notes = #{notes},
            discountamount = #{discountamount},
            filename = #{filename},
            filesize = #{filesize}
        WHERE membershipid = #{membershipid}
    </update>
   
    <delete id="delete" parameterType="string">
        DELETE FROM memberships
        WHERE membershipid = #{membershipid}
    </delete>
    
    <select id="filename" parameterType="string" resultType="string">
        SELECT filename
        FROM memberships
        WHERE membershipid = #{membershipid}
    </select>
    
    <select id="getTeamNames" resultType="string">
        SELECT teamname
        FROM teams
    </select>

    <!-- 페이징을 위한 쿼리 추가 -->
    <select id="listWithPaging" resultType="kr.co.matchday.memberships.MembershipsDTO" parameterType="map">
        SELECT membershipid, membershipname, teamname, price, startdate, enddate, notes, discountamount, filename, filesize
        FROM memberships
        WHERE startdate &lt;= #{currentDate} AND enddate &gt;= #{currentDate}
        ORDER BY membershipid
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countMemberships" resultType="int">
        SELECT COUNT(*) 
        FROM memberships
    </select>

    <!-- 검색 기능을 위한 쿼리 추가 -->
    <select id="search" resultType="kr.co.matchday.memberships.MembershipsDTO" parameterType="map">
        SELECT membershipid, membershipname, teamname, price, startdate, enddate, notes, discountamount, filename, filesize
        FROM memberships
        WHERE membershipname LIKE #{membershipname}
          AND startdate &lt;= #{currentDate} AND enddate &gt;= #{currentDate}
        ORDER BY membershipname
    </select>
    
    <select id="isMembershipPurchased" parameterType="java.util.HashMap" resultType="int">
        SELECT COUNT(*)
        FROM usermemberships
        WHERE userid = #{userID} AND membershipid = #{membershipID} AND status = 'completed'
    </select>
</mapper>
