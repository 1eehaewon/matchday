<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="review">
    <!-- 리뷰 추가 -->
    <insert id="insert" parameterType="kr.co.matchday.review.ReviewDTO">
        INSERT INTO review (reviewid, userid, matchid, goodsid, orderid, reviewdate, title, content, rating, grantedpoints, filename, filesize)
        VALUES (#{reviewid}, #{userid}, #{matchid}, #{goodsid}, #{orderid}, #{reviewdate}, #{title}, #{content}, #{rating}, #{grantedpoints}, #{filename}, #{filesize})
    </insert>

    <!-- 특정 상품의 리뷰 목록 조회 -->
    <select id="getReviewList" parameterType="String" resultType="kr.co.matchday.review.ReviewDTO">
        SELECT * FROM review WHERE goodsid = #{goodsid}
    </select>

    <!-- 특정 리뷰 조회 -->
    <select id="selectReviewById" parameterType="String" resultType="kr.co.matchday.review.ReviewDTO">
        SELECT * FROM review WHERE reviewid = #{reviewid}
    </select>

    <!-- 리뷰 업데이트 -->
    <update id="update" parameterType="kr.co.matchday.review.ReviewDTO">
        UPDATE review
        SET userid = #{userid}, matchid = #{matchid}, goodsid = #{goodsid}, orderid = #{orderid}, reviewdate = #{reviewdate},
            title = #{title}, content = #{content}, rating = #{rating}, grantedpoints = #{grantedpoints}, filename = #{filename}, filesize = #{filesize}
        WHERE reviewid = #{reviewid}
    </update>

    <!-- 리뷰 삭제 -->
    <delete id="reviewdelete" parameterType="String">
        DELETE FROM review WHERE reviewid = #{reviewid}
    </delete>

    <!-- 리뷰 ID에 해당하는 파일명 조회 -->
    <select id="filename" resultType="java.lang.String">
        SELECT filename
        FROM review
        WHERE reviewid = #{reviewid}
    </select>

    <!-- 모든 리뷰 조회 -->
    <select id="selectAll" resultType="kr.co.matchday.review.ReviewDTO">
        SELECT * FROM review
    </select>

    <!-- 특정 리뷰 상세 조회 -->
    <select id="getReviewById" resultType="kr.co.matchday.review.ReviewDTO" parameterType="String">
        SELECT *
        FROM review
        WHERE reviewid = #{reviewid}
    </select>

    <!-- 모든 리뷰 목록 조회 -->
    <select id="getAllReviews" resultType="kr.co.matchday.review.ReviewDTO">
        SELECT *
        FROM review
    </select>
    
    <!-- 포인트 적립 내역 추가 -->
    <insert id="insertPointHistory">
        INSERT INTO pointhistory (userid, pointtype, pointsource, pointamount, pointcreationdate)
        VALUES (#{userid}, '적립', #{pointSource}, #{pointAmount}, NOW())
    </insert>
    
    <!-- 특정 상품에 대한 주문 목록 조회 -->
    <select id="getOrderListByGoodsId" parameterType="map" resultType="kr.co.matchday.order.OrderDTO">
        SELECT orderid, goodsid
        FROM `order`
        WHERE goodsid = #{goodsid} AND userid = #{userid}
    </select>

    <!-- 특정 주문에 대한 리뷰 수 조회 -->
    <select id="countReviewByOrderId" parameterType="String" resultType="int">
        SELECT COUNT(*) FROM review WHERE orderid = #{orderid}
    </select>
</mapper>
