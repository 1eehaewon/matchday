<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- admin.xml -->

<mapper namespace="admin">

	<!-- 회원전체목록가져오기 -->
	<select id="selectAllUsers"
		resultType="kr.co.matchday.admin.AdminDTO">
		SELECT userid, name, email, grade, joinDate
		FROM users
	</select>

	<!-- 쿠폰등록하기 -->
	<insert id="insertCoupon"
		parameterType="kr.co.matchday.admin.CouponMasterDTO">
		INSERT INTO couponmaster (coupontypeid, couponname, discountrate,
		issuecount, startdate, enddate, applicableproduct)
		VALUES (#{coupontypeid}, #{couponname}, #{discountrate}, #{issuecount},
		#{startdate}, #{enddate}, #{applicableproduct})
	</insert>


	<!-- 쿠폰 전체 목록 가져오기 -->
	<select id="selectAllCoupons"
		resultType="kr.co.matchday.admin.CouponMasterDTO">
		SELECT coupontypeid, couponname, discountrate, issuecount, startdate,
		enddate, applicableproduct
		FROM couponmaster
	</select>

	<select id="getCouponById" parameterType="String"
		resultType="kr.co.matchday.admin.CouponMasterDTO">
		SELECT * FROM couponmaster WHERE coupontypeid = #{coupontypeid}
	</select>

	<update id="updateCoupon"
		parameterType="kr.co.matchday.admin.CouponMasterDTO">
		UPDATE couponmaster
		SET couponname = #{couponname},
		discountrate = #{discountrate},
		issuecount = #{issuecount},
		startdate = #{startdate},
		enddate = #{enddate},
		applicableproduct = #{applicableproduct}
		WHERE coupontypeid = #{coupontypeid}
	</update>

	<delete id="deleteCoupon" parameterType="String">
		DELETE FROM couponmaster WHERE coupontypeid = #{coupontypeid}
	</delete>

	<!-- 포인트마스터 -->
	<!-- 포인트 유형 목록 가져오기 -->
	<select id="getPointCategories"
		resultType="kr.co.matchday.admin.PointMasterDTO">
		SELECT pointcategoryid, pointcategoryname, accumulatedpoints, rate
		FROM pointmaster
	</select>

	<!-- 포인트 유형 추가 -->
	<insert id="createPoint"
		parameterType="kr.co.matchday.admin.PointMasterDTO">
		INSERT INTO pointmaster (pointcategoryname, accumulatedpoints, rate)
		VALUES (#{pointcategoryname}, #{accumulatedpoints}, #{rate})
	</insert>

	<delete id="deletePoint" parameterType="String">
		DELETE FROM pointmaster WHERE pointcategoryid = #{pointcategoryid}
	</delete>

	<!-- 회원사용총금액가져오기 -->
	<select id="getTotalSpentByUsers" resultType="map">
		SELECT
		u.userid,
		u.name,
		u.email,
		u.grade,
		u.joinDate,
		COALESCE(t.totalTicketAmount, 0) + COALESCE(m.totalMembershipAmount, 0) +
		COALESCE(o.totalOrderAmount, 0) AS totalSpent
		FROM
		users u
		LEFT JOIN
		(SELECT userid, SUM(finalpaymentamount) as totalTicketAmount FROM tickets
		GROUP BY userid) t ON u.userid = t.userid
		LEFT JOIN
		(SELECT um.userid, SUM(m.price) as totalMembershipAmount FROM usermemberships
		um JOIN memberships m ON um.membershipid = m.membershipid GROUP BY
		um.userid) m ON u.userid = m.userid
		LEFT JOIN
		(SELECT userid, SUM(finalpaymentamount) as totalOrderAmount FROM `order`
		GROUP BY userid) o ON u.userid = o.userid;
	</select>
	
	<!-- 회원 삭제 -->
    <delete id="deleteUserById">
        DELETE FROM users
        WHERE userid = #{userId}
    </delete>
</mapper>

